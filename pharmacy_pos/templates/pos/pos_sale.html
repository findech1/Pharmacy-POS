{% extends 'base.html' %}

{% block header %}Point of Sale{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Products Section -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Select Products</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for medicine in medicines %}
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer medicine-card" 
                     data-id="{{ medicine.id }}" 
                     data-name="{{ medicine.name }}" 
                     data-price="{{ medicine.price }}">
                    <h4 class="font-medium text-gray-900">{{ medicine.name }}</h4>
                    <p class="text-sm text-gray-600">{{ medicine.category.name }}</p>
                    <p class="text-lg font-semibold text-blue-600">${{ medicine.price }}</p>
                    <p class="text-xs text-gray-500">Stock: {{ medicine.total_quantity }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Cart Section -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-6 sticky top-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Sale Items</h3>
            
            <form method="post" action="{% url 'process_sale' %}" id="saleForm">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Customer (Optional)</label>
                    <select name="customer_id" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">Walk-in Customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                    <select name="payment_method" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="mobile">Mobile Money</option>
                    </select>
                </div>
                
                <div id="cartItems" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                    <!-- Cart items will be added here dynamically -->
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600">Subtotal:</span>
                        <span id="subtotal" class="font-semibold">$0.00</span>
                    </div>
                    
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm text-gray-600">Discount:</label>
                        <input type="number" name="discount" step="0.01" min="0" value="0" 
                               class="w-20 px-2 py-1 border border-gray-300 rounded text-right text-sm" 
                               id="discount">
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-sm text-gray-600">Tax:</label>
                        <input type="number" name="tax" step="0.01" min="0" value="0" 
                               class="w-20 px-2 py-1 border border-gray-300 rounded text-right text-sm" 
                               id="tax">
                    </div>
                    
                    <div class="flex justify-between items-center mb-4 text-lg font-semibold">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed" 
                            id="processBtn" disabled>
                        Process Sale
                    </button>
                    
                    <button type="button" 
                            class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 mt-2" 
                            onclick="clearCart()">
                        Clear Cart
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let cart = {};

document.addEventListener('DOMContentLoaded', function() {
    // Add click event to medicine cards
    document.querySelectorAll('.medicine-card').forEach(card => {
        card.addEventListener('click', function() {
            const id = this.dataset.id;
            const name = this.dataset.name;
            const price = parseFloat(this.dataset.price);
            
            addToCart(id, name, price);
        });
    });
    
    // Add event listeners for discount and tax
    document.getElementById('discount').addEventListener('input', updateTotal);
    document.getElementById('tax').addEventListener('input', updateTotal);
});

function addToCart(id, name, price) {
    if (cart[id]) {
        cart[id].quantity += 1;
    } else {
        cart[id] = {
            name: name,
            price: price,
            quantity: 1
        };
    }
    updateCartDisplay();
}

function removeFromCart(id) {
    delete cart[id];
    updateCartDisplay();
}

function updateQuantity(id, quantity) {
    if (quantity <= 0) {
        removeFromCart(id);
    } else {
        cart[id].quantity = quantity;
        updateCartDisplay();
    }
}

function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const saleForm = document.getElementById('saleForm');
    
    // Remove existing hidden inputs
    saleForm.querySelectorAll('input[name^="medicine_"]').forEach(input => {
        input.remove();
    });
    
    if (Object.keys(cart).length === 0) {
        cartItems.innerHTML = '<p class="text-gray-500 text-sm">No items in cart</p>';
        document.getElementById('processBtn').disabled = true;
    } else {
        let html = '';
        for (const [id, item] of Object.entries(cart)) {
            html += `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                    <div class="flex-1">
                        <p class="font-medium text-sm">${item.name}</p>
                        <p class="text-xs text-gray-600">${item.price.toFixed(2)} each</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" onclick="updateQuantity('${id}', ${item.quantity - 1})" 
                                class="w-6 h-6 bg-red-500 text-white rounded text-xs">-</button>
                        <span class="text-sm font-medium">${item.quantity}</span>
                        <button type="button" onclick="updateQuantity('${id}', ${item.quantity + 1})" 
                                class="w-6 h-6 bg-green-500 text-white rounded text-xs">+</button>
                    </div>
                    <button type="button" onclick="removeFromCart('${id}')" 
                            class="ml-2 text-red-500 hover:text-red-700">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `;
            
            // Add hidden input for this medicine
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = `medicine_${id}`;
            input.value = item.quantity;
            saleForm.appendChild(input);
        }
        cartItems.innerHTML = html;
        document.getElementById('processBtn').disabled = false;
    }
    
    updateTotal();
}

function updateTotal() {
    let subtotal = 0;
    for (const [id, item] of Object.entries(cart)) {
        subtotal += item.price * item.quantity;
    }
    
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const tax = parseFloat(document.getElementById('tax').value) || 0;
    const total = subtotal - discount + tax;
    
    document.getElementById('subtotal').textContent = `${subtotal.toFixed(2)}`;
    document.getElementById('total').textContent = `${total.toFixed(2)}`;
}

function clearCart() {
    cart = {};
    updateCartDisplay();
}
</script>
{% endblock %}

{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load humanize %}